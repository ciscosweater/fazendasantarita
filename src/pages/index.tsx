'use client';
import Head from 'next/head';
import styles from '@/styles/Home.module.css';
import InfoBlock from '@/components/block';
import {useEffect, useState} from 'react';

const apiUrl = "http://localhost:3000/api"

export default function Home() {
  const [diaAtual, setDiaAtual] = useState<number>();
  const [diasPassados, setDiasPassados] = useState<number>();

  const today = new Date();
  const day = today.getDate();
  const month = today.getMonth() + 1;
  const year = today.getFullYear();

  const diaPlantacao = new Date('2023-08-12')

  useEffect(() => {
    const differenceInTime = today.getTime() - diaPlantacao.getTime();
    const days = Math.floor(differenceInTime / (1000 * 3600 * 24));
    setDiasPassados(days);
  }, [diaPlantacao, today]);

  async function carregarDia(dia: number, mes: number) {
    const resp = await fetch(`${apiUrl}/infodias/${mes}/${dia}`);
    const json = await resp.json();
    setDiaAtual(json.info);
    console.log(`dia atual: ${json.info}`);
  }  

  useEffect(() => {
    carregarDia(day, month)
  }, [day, month])

  function renderizarDia(dia: any) {
    if (dia.length > 0) {
    return (
      dia.map((item: any) => (
        <InfoBlock key={item.key} group={item.group} title={item.title} amount={item.amount} />
      ))
    );
    }
  }  

  return (
    <>
      <Head>
        <title>Santa Rita</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div className={styles.main}>
        <div className={styles.header}>
          <p>Fertirrigação do dia {day}/{month}/{year}</p>
        </div>
        <div className={styles.blocksDiv}>
          {diaAtual && renderizarDia(diaAtual)}
        </div>
        <span className={styles.counterText}>Dias passados após a plantação: {diasPassados} dias</span>
      </div>
    </>
  )
}
